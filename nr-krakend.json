{
    "version": 2,
    "extra_config": {
        "github_com/devopsfaith/krakend-gologging": {
            "level": "DEBUG",
            "prefix": "[KRAKEND]",
            "stdout": true,
            "syslog": true
        }
    },
    "tls": {},
    "timeout": "20s",
    "read_timeout": "20s",
    "write_timeout": "20s",
    "read_header_timeout": "20s",
    "cache_ttl": "300s",
    "name": "NrApiGateway",
    "port": 8080,
    "endpoints": [
	      {
		        "endpoint": "/api/v1/validate",
		        "method": "GET",
            "extra_config": {},
            "querystring_params": [
                "api_key"
            ],
            "headers_to_pass": [
	              "Dd-Agent-Version",
                "Dd-Api-Key",
                "User-Agent",
                "Content-Encoding",
                "Content-Type",
                "Accept-Encoding"
            ],
            "backend": [
                {
                    "url_pattern": "/api/v1/validate",
                    "method": "GET",
                    "extra_config": {
                    },
                    "host": [
                        "https://app.datadoghq.com"
                    ]
                }
            ]
	      },
        {
            "endpoint": "/intake",
            "method": "POST",
            "extra_config": {
            },
            "querystring_params": [
                "api_key"
            ],
            "headers_to_pass": [
                "Dd-Agent-Version",
                "Dd-Api-Key",
                "User-Agent",
                "Content-Type",
                "Content-Encoding",
                "Accept-Encoding"
            ],
            "backend": [
                {
                    "url_pattern": "/intake",
                    "encoding": "string",
                    "method": "POST",
	                  "extra_config": {
				                "github.com/devopsfaith/krakend/http": {
                            "return_error_details": "backend_datadog"
                        }
	                  },
                    "host": [
			                  "https://app.datadoghq.com"
                    ]
                },
                {
                    "url_pattern": "/v1/accounts/ACCOUNT_ID/events",
                    "method": "POST",
                    "extra_config": {
                        "github.com/devopsfaith/krakend-martian": {
                            "fifo.Group": {
                                "scope": ["request", "response"],
                                "aggregateErrors": true,
                                "modifiers": [
                                    {
                                        "body.Template": {
                                            "backend_content_encoding": "gzip",
                                            "keys_to_extract": [
                                                "api_key"
                                            ],
					                                  "template": "{{ $index := 0 }}[{{ if .events }}{{ range $keyEvent, $events := .events }}{{ if ne $index 0 }},{{ end }}{{ range $indexEvent, $event := $events }}{{ $index = inc $index }}{{ if ne $indexEvent 0 }},{{ end }}{\"eventType\":\"{{ if $event.event_type }}{{ $event.event_type }}{{ else }}{{ $event.alert_type }}{{ end }}\"{{ range $attrEvent, $valueEvent := $event }},\"{{ $attrEvent }}\":{{ if eq (typeof $valueEvent) \"float64\" }}{{ printf \"%.0f\" $valueEvent }}{{ else }}{{ printf \"%q\" $valueEvent }}{{ end }}{{ end }}}{{ end }}{{ end }}{{ end }}]"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": ["request"],
                                            "name": "Api-Key",
                                            "value": "NR_API_KEY"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": ["request"],
                                            "name": "Dd-Api-Key",
                                            "value": ""
                                        }
                                    }
                                ]
                            }
                        }
	                  },
                    "host": [
                        "https://insights-collector.newrelic.com"
                    ]
                }
            ]
        },
        {
            "endpoint": "/api/v1/series",
            "method": "POST",
            "extra_config": {
                "github.com/devopsfaith/krakend/proxy": {
                    "sequential": true
                }
            },
            "querystring_params": [
                "api_key"
            ],
            "headers_to_pass": [
                "Dd-Agent-Version",
                "Dd-Api-Key",
                "User-Agent",
                "Content-Encoding",
                "Content-Type",
                "Accept-Encoding"
            ],
            "backend": [
                {
                    "url_pattern": "/api/v1/series",
                    "method": "POST",
                    "extra_config": {
	                  },
                    "host": [
                        "https://app.datadoghq.com"
                    ]
                }
                ,
                {
                    "url_pattern": "/metric/v1",
                    "method": "POST",
                    "extra_config": {
                        "github.com/devopsfaith/krakend-martian": {
                            "fifo.Group": {
                                "scope": ["request", "response"],
                                "aggregateErrors": true,
                                "modifiers": [
                                    {
                                        "body.Template": {
				                                    "endpoint_content_encoding": "deflate",
                                            "backend_content_encoding": "gzip",
                                            "keys_to_extract": [
                                                "api_key"
                                            ],
					                                  "template": "[{\"metrics\":[{{ range $indexSerie, $serie := .series }}{{ range $indexPoint, $point := .points }}{{ if and (eq $indexSerie 0) (eq $indexPoint 0) }}{{ else }},{{ end }}{\"name\":\"{{ $serie.metric }}\",\"type\":\"{{ if eq $serie.type \"rate\" }}gauge{{ else }}{{ $serie.type }}{{ end }}\",\"value\":{{ (index $point 1) }},\"timestamp\":{{ printf \"%.0f\" (index $point 0) }},\"attributes\":{\"host.name\":\"{{ $serie.host }}\"}}{{ end }}{{ end }}]}]"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": ["request"],
                                            "name": "Api-Key",
                                            "value": "NR_API_KEY"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": ["request"],
                                            "name": "Dd-Api-Key",
                                            "value": ""
                                        }
                                    }
                                ]
                            }
                        }
	                  },
                    "host": [
		                  "https://metric-api.newrelic.com"
                    ]
                }
            ]
        },
        {
            "endpoint": "/api/v1/check_run",
            "method": "POST",
            "extra_config": {},
            "headers_to_pass": [
                "Dd-Agent-Version",
                "Dd-Api-Key",
                "User-Agent",
                "Content-Encoding",
                "Content-Type",
                "Accept-Encoding"
            ],
            "querystring_params": [
                "api_key"
            ],
            "backend": [
                {
                    "url_pattern": "/api/v1/check_run",
                    "method": "POST",
                    "extra_config": {
	                  },
                    "host": [
                        "https://app.datadoghq.com"
                    ]
                }
            ]
        },
	      {
            "endpoint": "/v1/input/{api_key}",
            "method": "POST",
            "extra_config": {
                "github.com/devopsfaith/krakend/proxy": {
                    "sequential": true
                }
            },
            "headers_to_pass": [
                "Dd-Agent-Version",
                "Dd-Api-Key",
                "User-Agent",
                "Content-Encoding",
                "Content-Type",
                "Accept-Encoding"
            ],
            "backend": [
                {
                    "url_pattern": "/v1/input/{api_key}",
                    "method": "POST",
                    "extra_config": {
                        "github.com/devopsfaith/krakend/http": {
                            "return_error_details": "backend_datadog"
                        }
                    },
                    "host": [
                        "https://agent-http-intake.logs.datadoghq.com"
                    ]
                },
                {
                    "url_pattern": "/log/v1",
                    "method": "POST",
                    "extra_config": {
                        "github.com/devopsfaith/krakend-martian": {
                            "fifo.Group": {
                                "scope": [
                                    "request",
                                    "response"
                                ],
                                "aggregateErrors": true,
                                "modifiers": [
                                    {
                                        "body.Template": {
                                            "endpoint_content_encoding": "gzip",
                                            "backend_content_encoding": "gzip",
                                            "keys_to_extract": [],
                                            "template": "[ {{ range $indexLog, $log := . }} {{ if (eq $indexLog 0) }} {{ else }} ,{{ end }}  { \"message\": \"{{- js $log.message -}}\", \"timestamp\": {{ printf \"%.0f\" $log.timestamp }},  \"logtype\": \"accesslogs\", \"service\": \"{{$log.service}}\", \"hostname\": \"{{$log.hostname}}\", \"status\": \"{{$log.status}}\", \"ddsource\": \"{{$log.ddsource}}\", \"ddtags\": \"{{$log.ddtags}}\"   }  {{end}} ]"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": [
                                                "request"
                                            ],
                                            "name": "Api-Key",
                                            "value": "NR_API_KEY"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": [
                                                "request"
                                            ],
                                            "name": "Dd-Api-Key",
                                            "value": ""
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "host": [
                        "https://log-api.newrelic.com"
                    ]
                }
            ]
        },
        {
            "endpoint": "/api/v0.2/traces",
            "method": "POST",
            "extra_config": {
                "github.com/devopsfaith/krakend/proxy": {
                    "sequential": true
                }
            },
            "headers_to_pass": [
                "Dd-Agent-Version",
                "Dd-Api-Key",
                "User-Agent",
                "Content-Encoding",
                "Content-Type",
                "Accept-Encoding"
            ],
            "backend": [
                {
                    "url_pattern": "/api/v0.2/traces",
                    "method": "POST",
                    "extra_config": {
                        "github.com/devopsfaith/krakend/http": {
                            "return_error_details": "backend_datadog"
                        }
                    },
                    "host": [
                        "https://trace.agent.datadoghq.com"
                    ]
                },
                {
                    "url_pattern": "/trace/v1",
                    "method": "POST",
                    "extra_config": {
                        "github.com/devopsfaith/krakend/http": {
                            "return_error_details": "backend_newrelic"
                        },
                        "github.com/devopsfaith/krakend-martian": {
                            "fifo.Group": {
                                "scope": [
                                    "request",
                                    "response"
                                ],
                                "aggregateErrors": true,
                                "modifiers": [
                                    {
                                        "body.Template": {
                                            "endpoint_content_type": "application/x-protobuf",
                                            "endpoint_content_encoding": "gzip",
                                            "backend_content_encoding": "gzip",
                                            "keys_to_extract": [],
                                            "template": "[{{ range $indexTrace, $trace := .Traces }}{{ if (eq $indexTrace 0) }}{{ else }},{{ end }}{\"common\":{\"attributes\":{\"hostname\":\"{{ $.HostName }}\"}},\"spans\":[{{ range $indexSpan, $span := $trace.Spans }}{{ if (eq $indexSpan 0) }}{{ else }},{{ end }}{\"id\":\"{{ $span.SpanID }}\",\"trace.id\": \"{{ $trace.TraceID }}\",\"timestamp\":{{ Int64ToString $span.Start | printf \"%.13s\"}},\"attributes\":{\"service.name\":\"{{ $span.Service }}\",\"duration.ms\":\"{{ $span.Duration }}\",\"parent.id\":{{ if (eq $span.ParentID 0)}}null{{ else }}\"{{ $span.ParentID  }}\"{{ end }},\"name\":{{ printf \"%q\" $span.Resource }},\"resource\":{{ printf \"%q\" $span.Name }},\"type\":\"{{ $span.Type }}\",\"error\":\"{{ $span.Error }}\"{{ range $keyMeta, $valueMeta := $span.Meta }},\"{{ $keyMeta }}\":{{ printf \"%q\" $valueMeta }}{{ end }}}}{{ end }}]}{{ end }}]"
                                        }
                                    },
                                            {
                                        "header.Modifier": {
                                            "scope": [
                                                "request"
                                            ],
                                            "name": "Api-Key",
                                            "value": "NR_API_KEY"
                                        }
                                    },
                                    {
                                        "header.Modifier": {
                                            "scope": [
                                                "request"
                                            ],
                                            "name": "Dd-Api-Key",
                                            "value": ""
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "host": [
                        "https://trace-api.newrelic.com"
                    ]
                }
            ]
        }
    ]
}
